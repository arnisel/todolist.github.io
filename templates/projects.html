{% extends 'base.html' %}

{% block title %}Projelerim - G√∂rev Y√∂neticisi{% endblock %}

{% block content %}
  <div class="px-4 sm:px-8 md:px-16 lg:px-24 xl:px-40 flex flex-1 justify-center py-5">
    <div class="layout-content-container flex flex-col w-full max-w-[960px] flex-1">
      <!-- TopNavBar -->
      <header class="flex items-center justify-between whitespace-nowrap border-b border-solid border-gray-200/10 dark:border-white/10 px-4 sm:px-6 md:px-10 py-3">
        <div class="flex items-center gap-4 text-black dark:text-white">
          <div class="text-primary size-6">
             
          </div>
          <h2 class="text-lg font-bold leading-tight tracking-[-0.015em]">G√∂rev Y√∂neticisi</h2>
        </div>
        <!-- dark mode toggle moved to page CTA area -->
      </header>

      <!-- PageHeading & CTA -->
      <div class="flex flex-wrap items-center justify-between gap-4 p-4 mt-6">
        <p class="text-black dark:text-white text-4xl font-black leading-tight tracking-[-0.033em] min-w-[18rem]">Projelerim</p>
        <div class="flex items-center gap-3">
          <button class="js-toggle-color flex cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 w-10 bg-gray-200/50 dark:bg-white/10 text-black dark:text-white text-sm font-bold leading-normal tracking-[0.015em]">
             
          </button>
          <button type="button" class="js-open-new-project flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-primary text-black text-sm font-bold leading-normal tracking-[0.015em] gap-2 hover:opacity-90 transition-opacity">
             
            <span class="truncate">Yeni Proje Olu≈ütur</span>
          </button>
        </div>
      </div>

      <!-- SearchBar -->
      <div class="px-4 py-3">
        <label class="flex flex-col min-w-40 h-12 w-full">
          <div class="flex w-full flex-1 items-stretch rounded-lg h-full">
            <div class="text-gray-500 dark:text-gray-400 flex border-none bg-gray-100 dark:bg-black/20 items-center justify-center pl-4 rounded-l-lg border-r-0">
               
            </div>
            <input class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-r-lg text-black dark:text-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border-none bg-gray-100 dark:bg-black/20 h-full placeholder:text-gray-500 dark:placeholder:text-gray-400 pl-2 text-base font-normal leading-normal" placeholder="Projelerde ara..." value=""/>
          </div>
        </label>
      </div>

      <!-- Project Cards Grid -->
      <div class="grid grid-cols-[repeat(auto-fit,minmax(250px,1fr))] gap-4 p-4">
        {% for p in projects %}
        <div class="flex flex-col gap-4 rounded-xl bg-white dark:bg-black/20 p-5 border border-transparent hover:border-primary/50 transition-all shadow-sm hover:shadow-lg hover:shadow-primary/10" data-pid="{{ p.id if p.id is defined else '' }}" data-name="{{ p.name }}">
          <div class="flex items-start justify-between">
            <p class="text-black dark:text-white text-lg font-bold leading-normal">{{ p.name }}</p>
            <button class="js-delete-project ml-2 h-8 w-8 flex items-center justify-center rounded-lg border border-subtle-light dark:border-subtle-dark hover:bg-subtle-light/60 dark:hover:bg-subtle-dark text-red-600" data-id="{{ p.id if p.id is defined else '' }}" data-name="{{ p.name }}" title="Projeyi Sil">
               
            </button>
          </div>
          <p class="text-gray-600 dark:text-gray-300 text-sm font-normal leading-normal">{{ p.task_count }} G√∂rev</p>
          <div class="flex items-center gap-3">
            <div class="w-full bg-gray-200 dark:bg-white/10 rounded-full h-2">
              <div class="bg-primary h-2 rounded-full" data-percent="{{ p.percent }}" style="width:0;"></div>
            </div>
            <p class="text-black dark:text-white text-sm font-medium leading-normal">{{ p.percent }}%</p>
          </div>
        </div>
        {% endfor %}
      </div>

      <!-- Empty State Example -->
      {% if projects|length == 0 %}
      <div class="flex flex-col p-4 mt-8">
        <div class="flex flex-col items-center gap-6 rounded-xl border-2 border-dashed border-gray-300 dark:border-white/20 px-6 py-14 text-center">
          <span class="icon" aria-hidden="true">üìÅ</span>
          <div class="flex max-w-[480px] flex-col items-center gap-2">
            <p class="text-black dark:text-white text-lg font-bold leading-tight tracking-[-0.015em]">Hen√ºz projeniz yok</p>
            <p class="text-gray-600 dark:text-gray-300 text-sm font-normal leading-normal">ƒ∞lk projenizi olu≈üturarak g√∂revlerinizi y√∂netmeye ba≈ülayƒ±n!</p>
          </div>
          <button type="button" class="js-open-new-project flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-primary text-black text-sm font-bold leading-normal tracking-[0.015em] gap-2 hover:opacity-90 transition-opacity">
             
            <span class="truncate">ƒ∞lk Projeni Olu≈ütur</span>
          </button>
        </div>
      </div>
      {% endif %}

    </div>
  </div>
  <script>
    // Apply progress widths on the client to avoid template/CSS parsing issues
    (function(){
      document.querySelectorAll('[data-percent]').forEach(function(el){
        var v = el.getAttribute('data-percent') || '0';
        el.style.width = v + '%';
      });
    })();
  </script>
  <!-- New Project Modal -->
  <div id="newProjectModal" class="hidden fixed inset-0 z-50 flex items-center justify-center">
    <div class="absolute inset-0 bg-black/40"></div>
    <div class="relative w-full max-w-lg rounded-lg bg-white dark:bg-card-dark p-6 z-10">
      <h3 class="text-lg font-bold mb-4">Yeni Proje Olu≈ütur</h3>
      <form id="newProjectForm" method="post" action="{{ url_for('add_project') }}" class="space-y-3">
        <div>
          <label class="text-sm">Proje Adƒ±</label>
          <input name="name" required class="w-full rounded border px-3 py-2 mt-1 bg-white/0 dark:bg-card-dark text-text-light" />
        </div>
        <div>
          <label class="text-sm">A√ßƒ±klama (isteƒüe baƒülƒ±)</label>
          <textarea name="description" rows="3" class="w-full rounded border px-3 py-2 mt-1 bg-white/0 dark:bg-card-dark text-text-light"></textarea>
        </div>
        <div class="flex justify-end gap-2 pt-2">
          <button type="button" id="cancelNewProject" class="px-4 py-2 rounded bg-subtle-light/60 dark:bg-card-dark">ƒ∞ptal</button>
          <button type="submit" class="px-4 py-2 rounded bg-primary text-black font-bold">Olu≈ütur</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // local handlers for project modal
    (function(){
      const modal = document.getElementById('newProjectModal');
      const openBtns = Array.from(document.querySelectorAll('.js-open-new-project'));
      const cancelBtn = document.getElementById('cancelNewProject');
      openBtns.forEach(b => b && b.addEventListener('click', ()=>{ if(modal) modal.classList.remove('hidden'); }));
      if(cancelBtn) cancelBtn.addEventListener('click', ()=>{ if(modal) modal.classList.add('hidden'); });
    })();
  </script>
  <script>
    (function(){
      const delBtns = Array.from(document.querySelectorAll('.js-delete-project'));
      delBtns.forEach(btn => btn && btn.addEventListener('click', async function(e){
        const id = this.dataset.id;
        const name = this.dataset.name;
        if(!confirm('Bu projeyi ve i√ßindeki g√∂revleri silmek istediƒüinize emin misiniz?')) return;
        try{
          const res = await fetch("{{ url_for('delete_project') }}", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id: id || null, name: name })
          });
          const data = await res.json();
          if(!res.ok){ console.error('delete project failed', data); return; }
          // remove card DOM
          const card = this.closest('[data-pid], .flex.flex-col');
          if(card && card.parentNode) card.parentNode.removeChild(card);
        }catch(err){ console.error(err); }
      }));
    })();
  </script>
{% endblock %}
